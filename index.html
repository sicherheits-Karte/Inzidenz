<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Einbr√ºche & Diebst√§hle Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS STYLING (Identisch zum Original) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; height: 100vh; padding: 12px;
            color: #374151; overflow: hidden;
        }
        .container {
            max-width: 1400px; margin: 0 auto; display: grid;
            grid-template-columns: 280px 1fr; gap: 12px;
            height: calc(100vh - 24px); overflow: hidden;
        }

        /* Karten Design */
        .card-base {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-card { grid-column: 1 / -1; text-align: center; }
        .header-content h1 { font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .header-content .subtitle { font-size: 14px; color: #6b7280; font-weight: 400; }

        .sidebar-card { display: flex; flex-direction: column; gap: 14px; overflow-y: auto; max-height: 100%; }
        .card-title { font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 6px; }

        /* Eingabefelder */
        .date-inputs { display: flex; flex-direction: column; gap: 12px; }
        .date-group { display: flex; flex-direction: column; gap: 6px; }
        .date-group label { font-size: 14px; font-weight: 500; color: #4b5563; }
        .date-input {
            padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;
            font-size: 14px; transition: all 0.2s ease; background: white; width: 100%;
        }
        .date-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Buttons */
        .filter-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .filter-btn {
            padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.2s ease; background: #f8fafc; color: #4b5563;
        }
        .filter-btn:hover { background: #3b82f6; color: white; border-color: #3b82f6; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .filter-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        .link-btn {
            display: block; padding: 14px 20px; text-align: center; text-decoration: none;
            border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.2s ease; border: 2px solid;
        }
        .link-btn.datenquelle { background: #f0fdf4; color: #15803d; border-color: #86efac; }
        .link-btn.datenquelle:hover { background: #15803d; color: white; border-color: #15803d; transform: translateY(-1px); }
        .link-btn.paypal { background: linear-gradient(135deg, #0070ba, #1546a0); color: white; border-color: #0070ba; }
        .link-btn.paypal:hover { background: linear-gradient(135deg, #005a94, #103a7f); transform: translateY(-1px); }

        /* Info Box Rot */
        .state-info-card {
            background: linear-gradient(135deg, #dc2626, #ef4444); color: white;
            padding: 20px; border-radius: 12px; text-align: center;
            height: 190px; flex-shrink: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px;
        }
        .state-info-card h3 { font-size: 14px; font-weight: 600; opacity: 0.9; min-height: 40px; display: flex; align-items: center; justify-content: center; width: 100%; margin: 0; }
        .state-count { font-size: 24px; font-weight: 700; line-height: 1.2; }
        
        .link-btn.details { 
            background: white; color: #dc2626; border-color: #fca5a5; font-weight: 600;
            visibility: hidden; opacity: 0; display: block; width: 100%; height: 48px; margin-top: 5px;
            transition: opacity 0.2s ease;
        }
        .link-btn.details:hover { background: #fef2f2; border-color: #dc2626; }
        .link-btn.details.is-visible { visibility: visible; opacity: 1; }

        /* Map Bereich */
        .map-card { display: flex; flex-direction: column; overflow: hidden; }
        .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .map-title { font-size: 18px; font-weight: 600; color: #1f2937; }
        .vorf√§lle-count { font-size: 16px; font-weight: 600; color: #dc2626; }
        .map-container {
            flex: 1; background: white; border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); overflow: hidden; position: relative;
        }
        #map { width: 100%; height: 100%; background: #f8fafc; }

        /* Footer */
        .footer { grid-column: 1 / -1; padding: 12px 16px; text-align: center; }
        .footer-links { display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; }
        .footer-link { color: #6b7280; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s ease; position: relative; }
        .footer-link:hover { color: #3b82f6; }
        .footer-link::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background: #3b82f6; transition: width 0.2s ease; }
        .footer-link:hover::after { width: 100%; }

        /* Kartenelemente */
        .state { fill: white; stroke: #d1d5db; stroke-width: 1; transition: all 0.3s ease; cursor: pointer; }
        .state:hover { fill: #fef2f2; stroke: #dc2626; stroke-width: 2; }
        .state-selected { fill: #fca5a5 !important; stroke: #991b1b !important; stroke-width: 2px !important; }
        .incident { fill: rgba(220, 38, 38, 0.8); stroke: white; stroke-width: 1.5; r: 5; transition: all 0.3s ease; pointer-events: none; }
        .incident:hover { r: 7; fill: rgba(220, 38, 38, 1); stroke-width: 2; }
        .state-highlight { fill: #fecaca !important; stroke: #dc2626 !important; stroke-width: 3px !important; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .close { color: #9ca3af; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close:hover { color: #111; }
        .modal-header h2 { font-size: 20px; color: #1f2937; margin-bottom: 15px; border-bottom: 2px solid #f3f4f6; padding-bottom: 10px; }
        
        .search-container { margin-bottom: 15px; }
        .search-input { width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .search-input:focus { outline: none; border-color: #3b82f6; }
        .city-list { max-height: 50vh; overflow-y: auto; padding-right: 5px; }
        .city-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        .city-item:last-child { border-bottom: none; }
        .city-name { font-weight: 600; color: #374151; }
        .city-count { background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 13px; }

        /* Responsive */
        @media (max-width: 1024px) {
            body { padding: 8px; height: auto; min-height: 100vh; overflow-y: auto; }
            .container { grid-template-columns: 1fr; height: auto; min-height: calc(100vh - 16px); gap: 12px; overflow: visible; }
            .header-card { padding: 12px; }
            .sidebar-card { order: 2; max-height: none; overflow-y: visible; }
            .date-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            .map-card { order: 1; min-height: 400px; height: 60vh; }
            .footer { order: 3; padding: 12px; }
        }
        @media (max-width: 640px) {
            body { padding: 6px; }
            .container { gap: 8px; min-height: calc(100vh - 12px); }
            .map-card { min-height: 350px; height: 50vh; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card card-base">
            <div class="header-content">
                <h1>Einbr√ºche & Diebst√§hle Dashboard</h1>
                <div class="subtitle">Echtzeit-√úberwachung von Vorf√§llen in Deutschland</div>
            </div>
        </div>

        <div class="sidebar-card card-base">
            <div>
                <h3 class="card-title">Zeitfilter</h3>
                <div class="date-inputs">
                    <div class="date-group">
                        <label for="fromDate">Von</label>
                        <input type="date" id="fromDate" class="date-input">
                    </div>
                    <div class="date-group">
                        <label for="toDate">Bis</label>
                        <input type="date" id="toDate" class="date-input">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="card-title">Schnellfilter</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" id="todayBtn">Heute</button>
                    <button class="filter-btn" id="weekBtn">Diese Woche</button>
                    <button class="filter-btn" id="monthBtn">Dieser Monat</button>
                    <button class="filter-btn" id="yearBtn">Dieses Jahr</button>
                </div>
            </div>

            <div><a href="daten.html" class="link-btn datenquelle">üìä Datenquelle</a></div>
            <div><a href="https://www.paypal.com/paypalme/JulianKircher231" class="link-btn paypal">‚òï Unterst√ºtzen via PayPal</a></div>

            <div class="state-info-card">
                <h3>Ausgew√§hltes Bundesland</h3>
                <div class="state-count" id="stateInfo">-</div>
                <button id="showDetailsBtn" class="link-btn details">üìç Orte anzeigen</button>
            </div>
        </div>

        <div class="map-card card-base">
            <div class="map-header">
                <div class="map-title">Deutschland Karte</div>
                <div class="vorf√§lle-count" id="countDisplay">0 Vorf√§lle</div>
            </div>
            <div class="map-container">
                <svg id="map"></svg>
            </div>
        </div>

        <div class="footer card-base">
            <div class="footer-links">
                <a href="impressum.html" class="footer-link">Impressum</a>
                <span style="color: #d1d5db;">|</span>
                <a href="datenschutz.html" class="footer-link">Datenschutz</a>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
            </div>
            <div class="search-container">
                <input type="text" id="citySearch" class="search-input" placeholder="üîç Stadt suchen">
            </div>
            <div id="modalList" class="city-list"></div>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURATION & STATE ---
        const config = {
            geoJsonUrl: "https://raw.githubusercontent.com/isellsoap/deutschlandGeoJSON/main/2_bundeslaender/2_hoch.geo.json",
            dataUrl: "./data/einbrueche_diebstaehle.txt"
        };

        const state = {
            incidents: [],
            geoFeatures: [],
            selectedStateFeature: null,
            incidentCacheByState: {} // Performance-Cache f√ºr schnelle Lookups
        };

        // DOM Elemente cachen f√ºr schnellen Zugriff
        const elements = {
            mapSvg: d3.select("#map"),
            fromDate: document.getElementById("fromDate"),
            toDate: document.getElementById("toDate"),
            countDisplay: document.getElementById("countDisplay"),
            stateInfo: document.getElementById("stateInfo"),
            detailsBtn: document.getElementById("showDetailsBtn"),
            modal: document.getElementById("detailsModal"),
            modalList: document.getElementById("modalList"),
            citySearch: document.getElementById("citySearch"),
            modalTitle: document.getElementById("modalTitle"),
            closeModal: document.querySelector(".close")
        };

        // Map Setup
        const projection = d3.geoMercator().center([10.5, 51.0]).scale(2600).translate([0, 0]);
        const pathGenerator = d3.geoPath().projection(projection);
        const mapGroup = elements.mapSvg.append("g");
        
        // Zoom Verhalten
        elements.mapSvg.call(d3.zoom().scaleExtent([0.5, 12]).on("zoom", (e) => {
            mapGroup.attr("transform", e.transform);
        }));

        // --- 2. DATEN LADEN & PARSEN (OPTIMIERT) ---

        async function init() {
            setInitialDates();
            setupEventListeners();
            
            try {
                // GeoJSON laden
                const geoResponse = await d3.json(config.geoJsonUrl);
                state.geoFeatures = geoResponse.features;
                renderMapBase();

                // Incident Daten laden & periodisch aktualisieren
                await loadIncidents();
                setInterval(loadIncidents, 120000); // Alle 2 Min Update

                // Resize Handler
                window.addEventListener('resize', updateMapDimensions);
                updateMapDimensions();

            } catch (err) {
                console.error("Initialisierungsfehler:", err);
            }
        }

        async function loadIncidents() {
            try {
                const ts = new Date().getTime();
                const res = await fetch(`${config.dataUrl}?t=${ts}`);
                if(!res.ok) throw new Error("Netzwerkfehler");
                const text = await res.text();
                
                parseIncidents(text);
                
                // WICHTIG: Pre-Calculation der Bundesl√§nder f√ºr Performance
                if(state.geoFeatures.length > 0) {
                    assignStatesToIncidents(); 
                }

                updateView();
            } catch (e) { console.warn("Daten konnten nicht geladen werden", e); }
        }

        function parseIncidents(rawText) {
            state.incidents = [];
            const lines = rawText.split('\n');

            lines.forEach((line, idx) => {
                if(!line || !line.trim()) return;

                const parts = line.split('//');
                let jsonStr = parts[0].trim();
                const comment = parts[1] ? parts[1].trim() : "";

                // Fix: Trailing Comma entfernen f√ºr JSON Validit√§t
                if(jsonStr.endsWith(',')) jsonStr = jsonStr.slice(0, -1);

                try {
                    if(jsonStr.startsWith('{') && jsonStr.includes('}')) {
                        const data = JSON.parse(jsonStr);
                        
                        // Stadtname aus Kommentar extrahieren
                        let cityName = comment.split(',')[0].trim();
                        if(!cityName) cityName = "Unbekannter Ort";

                        if(data.coords && data.coords.length === 2) {
                            state.incidents.push({
                                id: idx,
                                coords: data.coords,
                                date: data.date,
                                city: cityName,
                                stateName: "Unbekannt" // Wird gleich berechnet
                            });
                        }
                    }
                } catch(e) { /* Fehler ignorieren, weitermachen */ }
            });
        }

        // --- 3. PERFORMANCE LOGIK: ZUORDNUNG VORBERECHNEN ---
        
        function assignStatesToIncidents() {
            // Dies l√§uft nur EINMAL beim Laden, nicht bei jedem Klick!
            state.incidents.forEach(inc => {
                // Performance: d3.geoContains ist effizient, aber teuer in Schleifen.
                // Wir machen das hier einmalig, damit die UI sp√§ter fl√ºssig ist.
                const foundState = state.geoFeatures.find(feature => 
                    d3.geoContains(feature, inc.coords)
                );
                
                if(foundState) {
                    inc.stateName = foundState.properties.NAME_1 || foundState.properties.name;
                }
            });
        }

        // --- 4. RENDERING & UI LOGIK ---

        function renderMapBase() {
            mapGroup.selectAll("path")
                .data(state.geoFeatures)
                .enter().append("path")
                .attr("class", "state")
                .attr("d", pathGenerator)
                .on("click", handleStateClick)
                .on("mouseover", function() { if(!state.selectedStateFeature) d3.select(this).classed("state-highlight", true); })
                .on("mouseout", function() { if(!state.selectedStateFeature) d3.select(this).classed("state-highlight", false); });
        }

        function updateView() {
            const from = elements.fromDate.value;
            const to = elements.toDate.value;
            
            // Filterung nach Datum
            const filtered = state.incidents.filter(d => d.date >= from && d.date <= to);
            
            // Map Punkte zeichnen
            const circles = mapGroup.selectAll(".incident").data(filtered, d => d.id);
            circles.exit().remove();
            
            circles.enter().append("circle")
                .attr("class", "incident")
                .attr("r", 5)
                .merge(circles)
                .attr("cx", d => projection(d.coords)[0])
                .attr("cy", d => projection(d.coords)[1]);

            elements.countDisplay.textContent = `${filtered.length} Vorf√§lle`;

            // State Info Box aktualisieren falls ausgew√§hlt
            if(state.selectedStateFeature) {
                updateSidebarInfo(state.selectedStateFeature, filtered);
            } else {
                elements.stateInfo.textContent = "-";
                elements.detailsBtn.classList.remove("is-visible");
            }
        }

        function handleStateClick(event, feature) {
            event.stopPropagation();
            
            // Toggle Auswahl
            if (state.selectedStateFeature === feature) {
                resetSelection(); // Abw√§hlen bei erneutem Klick
            } else {
                state.selectedStateFeature = feature;
                d3.selectAll(".state").classed("state-selected", false).classed("state-highlight", false);
                d3.select(this).classed("state-selected", true);
                updateView(); // Sidebar updaten
            }
        }

        function resetSelection() {
            state.selectedStateFeature = null;
            d3.selectAll(".state").classed("state-selected", false).classed("state-highlight", false);
            updateView();
        }

        function updateSidebarInfo(feature, currentFilteredIncidents) {
            const name = feature.properties.NAME_1 || feature.properties.name;
            
            // HIER IST DER PERFORMANCE GEWINN:
            // Statt Geometrie zu berechnen, filtern wir nur noch nach dem String-Namen
            const count = currentFilteredIncidents.filter(i => i.stateName === name).length;

            elements.stateInfo.textContent = `${name}: ${count}`;
            
            if(count > 0) {
                elements.detailsBtn.textContent = `üìç Details f√ºr ${name}`;
                elements.detailsBtn.classList.add("is-visible");
            } else {
                elements.detailsBtn.classList.remove("is-visible");
            }
        }

        function updateMapDimensions() {
            const container = document.querySelector('.map-container');
            const w = container.clientWidth;
            const h = container.clientHeight;
            elements.mapSvg.attr("width", w).attr("height", h);
            projection.translate([w / 2, h / 2]);
            mapGroup.selectAll("path").attr("d", pathGenerator);
            updateView();
        }

        // --- 5. MODAL LOGIK ---

        elements.detailsBtn.onclick = () => {
            if(!state.selectedStateFeature) return;
            
            const name = state.selectedStateFeature.properties.NAME_1 || state.selectedStateFeature.properties.name;
            const from = elements.fromDate.value;
            const to = elements.toDate.value;
            
            // Effiziente Filterung
            const incidentsInState = state.incidents.filter(i => 
                i.stateName === name && i.date >= from && i.date <= to
            );

            // Z√§hlen
            const counts = {};
            incidentsInState.forEach(i => counts[i.city] = (counts[i.city] || 0) + 1);
            
            const sorted = Object.entries(counts)
                .map(([city, count]) => ({city, count}))
                .sort((a,b) => b.count - a.count);

            // Render List
            elements.modalTitle.textContent = `Details f√ºr ${name}`;
            elements.citySearch.value = "";
            renderCityList(sorted);
            
            elements.modal.style.display = "block";
            setTimeout(() => elements.citySearch.focus(), 100);
        };

        function renderCityList(items) {
            if(items.length === 0) {
                elements.modalList.innerHTML = "<div style='padding:10px; text-align:center;'>Keine Daten.</div>";
                return;
            }
            // HTML String bauen ist schneller als viele appendChild calls
            elements.modalList.innerHTML = items.map(item => `
                <div class="city-item" data-name="${item.city.toLowerCase()}">
                    <span class="city-name">${item.city}</span>
                    <span class="city-count">${item.count}</span>
                </div>
            `).join('');
        }

        // Suche im Modal (Optimiert)
        elements.citySearch.onkeyup = function() {
            const term = this.value.toLowerCase();
            const items = elements.modalList.children;
            // Native Loop ist schnell genug f√ºr Listen < 1000 Elemente
            for(let item of items) {
                const name = item.getAttribute('data-name');
                item.style.display = name.includes(term) ? "flex" : "none";
            }
        };

        // Modal schlie√üen
        elements.closeModal.onclick = () => elements.modal.style.display = "none";
        window.onclick = (e) => { if(e.target == elements.modal) elements.modal.style.display = "none"; };

        // --- 6. HELPER & EVENTS ---

        function setInitialDates() {
            const today = new Date().toISOString().split('T')[0];
            elements.fromDate.value = today;
            elements.toDate.value = today;
        }

        function setupEventListeners() {
            elements.fromDate.addEventListener("change", updateView);
            elements.toDate.addEventListener("change", updateView);
            elements.mapSvg.on("click", resetSelection); // Klick auf Hintergrund

            // Filter Buttons Logik
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const today = new Date();
                    let start = new Date();
                    const endStr = today.toISOString().split('T')[0];
                    
                    switch(this.id) {
                        case 'todayBtn': break; // start ist schon heute
                        case 'weekBtn': 
                            const day = today.getDay() || 7; 
                            if(day !== 1) start.setHours(-24 * (day - 1)); 
                            break;
                        case 'monthBtn': start.setDate(1); break;
                        case 'yearBtn': start.setMonth(0, 1); break;
                    }
                    
                    elements.fromDate.value = start.toISOString().split('T')[0];
                    elements.toDate.value = endStr;
                    updateView();
                };
            });
        }

        // Starten
        init();
    </script>
</body>
</html>
