<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Einbr√ºche & Diebst√§hle Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN & CSS (Der sch√∂ne Look von vorher) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100vh;
            padding: 12px;
            color: #374151;
            overflow: hidden; /* Kein Scrollen auf dem Hauptbody */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 12px;
            height: calc(100vh - 24px);
        }

        /* Karten-Container Styles */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 16px;
        }

        /* Header */
        .header { grid-column: 1 / -1; text-align: center; }
        .header h1 { font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .header .subtitle { font-size: 14px; color: #6b7280; }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .section-title { font-size: 14px; font-weight: 600; color: #4b5563; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Datum Inputs */
        .date-group { margin-bottom: 12px; }
        .date-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; color: #4b5563; }
        .date-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .date-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Filter Buttons */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .filter-btn {
            padding: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        .filter-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; }

        /* Links & Buttons */
        .action-btn {
            display: block;
            width: 100%;
            padding: 12px;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 8px;
            transition: transform 0.1s;
        }
        .btn-green { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .btn-green:hover { background: #bbf7d0; }
        .btn-blue { background: #0070ba; color: white; }
        .btn-blue:hover { background: #005ea6; }

        /* Rote Info Box */
        .info-box {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .info-box h3 { font-size: 13px; opacity: 0.9; margin-bottom: 8px; }
        .info-count { font-size: 28px; font-weight: 700; }
        .details-link {
            display: inline-block;
            margin-top: 10px;
            background: white;
            color: #dc2626;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        /* Karte */
        .map-container { position: relative; width: 100%; height: 100%; overflow: hidden; background: #f8fafc; border-radius: 8px; }
        
        /* Map Styles */
        .state { fill: white; stroke: #cbd5e1; stroke-width: 1; transition: all 0.2s; cursor: pointer; }
        .state:hover { fill: #fee2e2; stroke: #ef4444; }
        .state.active { fill: #fecaca; stroke: #dc2626; stroke-width: 2; }
        
        .incident-dot { fill: rgba(220, 38, 38, 0.7); stroke: white; stroke-width: 1; transition: r 0.2s; cursor: crosshair; }
        .incident-dot:hover { fill: rgba(220, 38, 38, 1); r: 8 !important; }

        /* Footer */
        .footer { grid-column: 1 / -1; display: flex; justify-content: center; gap: 20px; font-size: 13px; }
        .footer a { color: #6b7280; text-decoration: none; }
        .footer a:hover { color: #374151; text-decoration: underline; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content {
            background: white; width: 90%; max-width: 400px; margin: 10% auto; padding: 24px;
            border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            position: relative;
        }
        .close-modal { position: absolute; top: 16px; right: 16px; font-size: 24px; cursor: pointer; color: #9ca3af; }
        .city-list { margin-top: 16px; max-height: 300px; overflow-y: auto; }
        .city-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .city-badge { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        
        /* Responsive */
        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; grid-template-rows: auto auto 500px auto; height: auto; display: block; }
            .sidebar { margin-bottom: 12px; max-height: none; }
            .map-container { height: 500px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card header">
        <h1>üõ°Ô∏è Sicherheits-Dashboard</h1>
        <div class="subtitle">Analyse von Einbr√ºchen & Diebst√§hlen in Deutschland</div>
    </div>

    <div class="card sidebar">
        <div>
            <div class="section-title">Zeitraum w√§hlen</div>
            <div class="date-group">
                <label>Von:</label>
                <input type="date" id="dateFrom" class="date-input">
            </div>
            <div class="date-group">
                <label>Bis:</label>
                <input type="date" id="dateTo" class="date-input">
            </div>
            
            <div class="filter-grid">
                <button class="filter-btn active" onclick="setFilter('today', this)">Heute</button>
                <button class="filter-btn" onclick="setFilter('week', this)">Woche</button>
                <button class="filter-btn" onclick="setFilter('month', this)">Monat</button>
                <button class="filter-btn" onclick="setFilter('year', this)">Jahr</button>
            </div>
        </div>

        <div style="margin-top: auto;">
            <a href="daten.html" class="action-btn btn-green">üìä Datenquelle</a>
            <a href="https://www.paypal.com/paypalme/JulianKircher231" target="_blank" class="action-btn btn-blue">‚òï Unterst√ºtzen</a>
            
            <div class="info-box" style="margin-top: 12px;">
                <h3 id="selectedStateName">Deutschland gesamt</h3>
                <div class="info-count" id="incidentCount">0</div>
                <button class="details-link" id="detailsBtn" style="display: none;">Details anzeigen</button>
            </div>
        </div>
    </div>

    <div class="card map-card" style="padding: 0; overflow: hidden;">
        <div class="map-container" id="mapContainer"></div>
    </div>

    <div class="card footer">
        <a href="impressum.html">Impressum</a>
        <a href="datenschutz.html">Datenschutz</a>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modalTitle" style="font-size: 18px; color: #1f2937; margin-bottom: 4px;">Details</h2>
        <p style="font-size: 13px; color: #6b7280;">Anzahl der Vorf√§lle pro Stadt</p>
        <div class="city-list" id="cityList"></div>
    </div>
</div>

<script>
    // --- 1. DIE DATENBANK (Hier tr√§gst du deine Daten ein!) ---
    // Format: { stadt: "Name", coords: [L√§ngengrad, Breitengrad], date: "YYYY-MM-DD" }
    // Damit umgehen wir alle Probleme mit externen Dateien.
    const incidents = [
        { stadt: "D√ºsseldorf", coords: [6.77, 51.22], date: "2025-12-08" },
        { stadt: "D√ºsseldorf", coords: [6.78, 51.23], date: "2025-12-08" },
        { stadt: "D√ºsseldorf", coords: [6.76, 51.21], date: "2025-12-08" },
        { stadt: "D√ºsseldorf", coords: [6.79, 51.20], date: "2025-12-08" },
        { stadt: "D√ºsseldorf", coords: [6.80, 51.24], date: "2025-12-08" },
        { stadt: "K√∂ln",       coords: [6.96, 50.93], date: "2025-12-08" },
        { stadt: "Berlin",     coords: [13.40, 52.52], date: "2025-12-08" },
        { stadt: "Hamburg",    coords: [9.99, 53.55], date: "2025-12-07" }, // Gestern
        { stadt: "M√ºnchen",    coords: [11.58, 48.13], date: "2025-12-07" },
        { stadt: "D√ºsseldorf", coords: [6.77, 51.22], date: "2025-12-07" }
    ];

    // --- 2. KARTEN SETUP ---
    const width = document.getElementById('mapContainer').clientWidth;
    const height = document.getElementById('mapContainer').clientHeight;

    const svg = d3.select("#mapContainer").append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", `0 0 ${width} ${height}`);

    const projection = d3.geoMercator()
        .center([10.5, 51.3]) // Deutschland Zentrum
        .scale(width * 2.5)   // Zoomfaktor dynamisch an Breite anpassen
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);
    const g = svg.append("g"); // Gruppe f√ºr Zoom

    // Zoom Funktion
    const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", (event) => g.attr("transform", event.transform));
    svg.call(zoom);

    let statesFeatures = [];
    let activeState = null;

    // --- 3. LOGIK ---
    
    // Datum Hilfsfunktionen
    const getToday = () => new Date().toISOString().split('T')[0];
    const getPastDate = (days) => {
        const d = new Date(); d.setDate(d.getDate() - days);
        return d.toISOString().split('T')[0];
    };
    
    // Initiale Werte
    document.getElementById('dateFrom').value = getToday();
    document.getElementById('dateTo').value = getToday();

    function setFilter(type, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const today = getToday();
        if(type === 'today') {
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
        } else if (type === 'week') {
            document.getElementById('dateFrom').value = getPastDate(7);
            document.getElementById('dateTo').value = today;
        } else if (type === 'month') {
            document.getElementById('dateFrom').value = getPastDate(30);
            document.getElementById('dateTo').value = today;
        } else if (type === 'year') {
            document.getElementById('dateFrom').value = new Date().getFullYear() + "-01-01";
            document.getElementById('dateTo').value = today;
        }
        updateMap();
    }

    // GeoJSON laden
    d3.json("https://raw.githubusercontent.com/isellsoap/deutschlandGeoJSON/main/2_bundeslaender/2_hoch.geo.json")
        .then(data => {
            statesFeatures = data.features;
            
            // Bundesl√§nder zeichnen
            g.selectAll("path")
                .data(statesFeatures)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "state")
                .on("click", handleStateClick);
                
            updateMap();
        })
        .catch(err => console.error("Fehler beim Laden der Karte:", err));

    // Update Funktion
    function updateMap() {
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;

        // 1. Daten filtern
        const visibleIncidents = incidents.filter(d => d.date >= from && d.date <= to);

        // 2. Punkte zeichnen
        const circles = g.selectAll("circle").data(visibleIncidents);
        
        circles.exit().remove();
        
        circles.enter().append("circle")
            .attr("class", "incident-dot")
            .attr("r", 4)
            .merge(circles)
            .attr("cx", d => projection(d.coords)[0])
            .attr("cy", d => projection(d.coords)[1]);

        // 3. Infos aktualisieren
        updateInfoBox(visibleIncidents);
    }

    // Interaktionen
    function handleStateClick(event, d) {
        // Reset Auswahl
        if (activeState === d) {
            activeState = null;
            d3.selectAll(".state").classed("active", false);
            updateMap(); // Zeigt wieder alles an
            return;
        }
        
        activeState = d;
        d3.selectAll(".state").classed("active", false);
        d3.select(this).classed("active", true);
        updateMap();
    }

    // Polygon Pr√ºfung
    function isPointInState(point, stateFeature) {
        return d3.geoContains(stateFeature, point);
    }

    function updateInfoBox(currentData) {
        let count = 0;
        let title = "Deutschland gesamt";
        let localData = currentData;

        if (activeState) {
            title = activeState.properties.NAME_1;
            // Filtere Punkte, die wirklich in diesem Bundesland liegen
            localData = currentData.filter(d => isPointInState(d.coords, activeState));
            count = localData.length;
        } else {
            count = currentData.length;
        }

        document.getElementById('incidentCount').innerText = count;
        document.getElementById('selectedStateName').innerText = title;
        
        // Button Logik
        const btn = document.getElementById('detailsBtn');
        if (activeState && count > 0) {
            btn.style.display = "inline-block";
            btn.onclick = () => openModal(title, localData);
        } else {
            btn.style.display = "none";
        }
    }

    // Modal Logik
    const modal = document.getElementById('modal');
    document.querySelector('.close-modal').onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if(e.target == modal) modal.style.display = "none"; };

    function openModal(stateName, data) {
        document.getElementById('modalTitle').innerText = "Vorf√§lle in " + stateName;
        
        // St√§dte z√§hlen
        const cityCounts = {};
        data.forEach(d => {
            const city = d.stadt || "Unbekannter Ort";
            cityCounts[city] = (cityCounts[city] || 0) + 1;
        });

        // Sortieren
        const sorted = Object.entries(cityCounts).sort((a,b) => b[1] - a[1]);

        const html = sorted.map(([city, num]) => `
            <div class="city-row">
                <span>${city}</span>
                <span class="city-badge">${num}</span>
            </div>
        `).join('');
        
        document.getElementById('cityList').innerHTML = html;
        modal.style.display = "block";
    }

    // Event Listener f√ºr Inputs
    document.getElementById('dateFrom').onchange = updateMap;
    document.getElementById('dateTo').onchange = updateMap;

    // Resize Handler
    window.onresize = () => {
        const w = document.getElementById('mapContainer').clientWidth;
        // ... hier k√∂nnte man die Projektion updaten, aber Reload reicht meistens
    };

</script>
</body>
</html>
